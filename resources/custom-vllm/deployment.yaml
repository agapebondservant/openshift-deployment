apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: custom-vllm-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 80Gi
  storageClassName: default
  volumeMode: Filesystem
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: custom-vllm-server
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: custom-vllm-server
  template:
    metadata:
      labels:
        app: custom-vllm-server
    spec:
      nodeSelector:
        gpu: "true"
      containers:
        - name: vllm-container
          image: vllm/vllm-openai:latest # Use a suitable vLLM image
          ports:
            - containerPort: 8000
          env:
            - name: HF_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hf-token-secret # Name of your Kubernetes Secret
                  key: token
          command: ["python", "-m", "vllm.entrypoints.openai.api_server"]
          args:
            - "--model"
            - "ibm-granite/granite-4.0-h-tiny"
            - "--port"
            - "8000"
            - "--dtype"
            - "bfloat16"
            - "--max-model-len"
            - "8192"
            - "--trust-remote-code"
            - "--gpu-memory-utilization"
            - "0.9"
          resources:
            requests:
              cpu: "4"
              memory: "32Gi"
              nvidia.com/gpu: "1"
            limits:
              cpu: "8"
              memory: "64Gi"
              nvidia.com/gpu: "1"
          volumeMounts:
            - name: model-storage
              mountPath: /models
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: custom-vllm-pvc
---
kind: Service
apiVersion: v1
metadata:
  name: custom-vllm-service
spec:
  ipFamilies:
    - IPv4
  ports:
    - name: api
      protocol: TCP
      port: 8000
      targetPort: 8000
  internalTrafficPolicy: Cluster
  type: ClusterIP
  ipFamilyPolicy: SingleStack
  sessionAffinity: None
  selector:
    app: custom-vllm
---
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  name: custom-vllm-route
spec:
  to:
    kind: Service
    name: custom-vllm-service
    weight: 100
  port:
    targetPort: main
  wildcardPolicy: None
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect